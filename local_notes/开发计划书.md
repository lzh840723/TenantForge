# 多租户「项目&工时」SaaS Starter 开发计划书（Codex 专用）

- 参考：`local_notes/PRD.md`

## 0. DoR 评估
 - [x] 需求目标：明确 1 周交付可演示的 SaaS MVP。
 - [x] 范围边界：账号/RBAC、多租户隔离、Project/Task/TimeEntry CRUD、报表、观测、部署。
 - [ ] 验收标准：需补充用户旅程与非功能指标后锁定。
 - [x] 依赖清单：Supabase、Railway、GitHub Actions、Vercel。
 - [ ] 优先级：默认按 PRD 顺序，需确认最终顺序。
 - [ ] 度量口径：需定义响应时间、成功率、部署频次等指标。

## 1. 目标与度量
- **业务目标**：交付一个可向潜在客户演示的多租户项目/工时管理骨架。
- **成功指标**：
  - Demo API 平台（Swagger UI）可用率 ≥ 99%（7×24h 内统计）。
  - 关键 API P95 响应时间 ≤ 300ms（单租户，10 并发下）。
  - 集成测试覆盖核心用例（注册、登录、RLS 保护、CRUD、报表）。
  - 交付物：部署链接、测试报告、Postman 集合、演示录屏。

## 2. 范围与里程碑
- **M1（Day 1-2）基础设施就绪**：项目骨架、Flyway、RLS POC、CI 基线。
- **M2（Day 3-5）核心功能完成**：认证、RBAC、多租户 CRUD、报表。
- **M3（Day 6）质量闭环**：测试、观测、CI/CD、部署流水线。
- **M4（Day 7）验收与证据**：Demo、文档、录屏、工时汇报。

## 3. 工作分解结构（WBS）
### 3.1 环境与基础设施
- [x] Spring Boot 骨架：Java 21 + Gradle/Maven，就绪后端基础设施（1 人日）
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [x] 数据迁移：Flyway 建立租户、用户、项目、任务、工时脚本（0.5 人日）
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [x] 数据服务：Supabase 启用 RLS、配置服务账号，作为统一云数据库（0.5 人日）
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [x] 容器兜底：保留 `backend/Dockerfile` / `docker-compose.yml` 作为本地/CI 诊断备选（主流程仍走云端环境）（0.5 人日）
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [x] 云端部署：前端 Vercel、后端 Railway、数据库 Supabase（0.5 人日）
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [x] 云端执行原则：CI、回归测试与演示默认在上述云环境完成，确保配置一致性（0.125 人日）
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）

### 3.2 部署与运维
- [x] CI/CD 流水线巡检与回滚策略（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
 - [x] 运行监控：日志、指标、告警配置（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）

### 3.3 身份认证与 RBAC
- [x] 实现注册、登录、刷新令牌 API（1 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [x] 配置 Spring Security、JWT 过滤器、密码策略（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [x] RBAC 角色与权限校验（TENANT_ADMIN / USER）（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）

### 3.4 多租户隔离
- [x] 拦截器设置 `app.tenant_id`，与数据源绑定（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [x] 编写 RLS 策略和租户隔离集成测试（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [x] 审计字段、变更日志表与监听器（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）

### 3.5 业务域（Project/Task/TimeEntry）
- [x] CRUD API + 验证 + DTO 映射（1.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [x] 分页、过滤、排序、软删除实现（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [x] 领域服务单元测试（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）

### 3.6 报表与导出
- [ ] 周/月工时聚合 SQL + 视图/物化视图（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [ ] 验证（AC 自动验证+证据）
- [x] 报表 API + CSV/JSON 导出（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [ ] 性能基准测试（Explain Analyze 与索引验证）（0.5 人日）。
  - [ ] 本地构建/编译通过
  - [ ] Git 提交（分支+推送）
  - [ ] PR（CI 全绿）
  - [ ] 验证（AC 自动验证+证据）

### 3.7 API 文档与观测
- [ ] 集成 springdoc-openapi，编写标签与示例（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [ ] Actuator 端点、Micrometer 指标、健康探针（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [x] 验证（AC 自动验证+证据）
- [ ] Postman 集合与演示脚本（0.5 人日）。
  - [ ] 文档构建/拼写/链接检查
  - [ ] 交付物路径有效（docs/集合 URL）
  - [ ] 发布说明草案生成
  - [ ] 演示脚本/示例生成

### 3.8 测试与 CI/CD
- [ ] Testcontainers 集成测试覆盖核心用例（1 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [ ] 验证（AC 自动验证+证据）
- [ ] GitHub Actions 工作流：构建、测试、Docker Build & Push（0.5 人日）。
  - [x] 本地构建/编译通过
  - [x] Git 提交（分支+推送）
  - [x] PR（CI 全绿）
  - [ ] 验证（AC 自动验证+证据）
- [ ] 覆盖率门槛配置（差分 ≥ 90%，全局 ≥ 80%）（0.5 人日）。
  - [x] 本地构建/编译通过
  - [ ] Git 提交（分支+推送）
  - [ ] PR（CI 全绿）
  - [ ] 验证（AC 自动验证+证据）

### 3.9 交付资产
- [ ] README、架构图、API 文档归档（0.5 人日）。
  - [ ] 文档构建/拼写/链接检查
  - [ ] 交付物路径有效（docs 路径/URL）
  - [ ] 发布说明草案生成
  - [ ] 演示脚本/示例生成
- [ ] 测试报告、覆盖率截图、日志样例（0.5 人日）。
  - [ ] 文档构建/拼写/链接检查
  - [ ] 交付物路径有效（报告/截图/日志路径）
  - [ ] 发布说明草案生成
  - [ ] 演示脚本/示例生成
- [ ] Demo 录屏与工时汇总报告（0.5 人日）。
  - [ ] 文档构建/拼写/链接检查
  - [ ] 交付物路径有效（录屏/报告路径）
  - [ ] 发布说明草案生成
  - [ ] 演示脚本/示例生成

### 3.10 状态与收尾（Codex 自动）
- [ ] 生成/更新状态与看板
  - [ ] 生成或更新 `status.json`/`status.md`（任务进度、证据链接、CI 状态、覆盖率）
  - [ ] 生成 `board.md`（列：待做/开发/联调/测试/灰度/已发布）
  - [ ] 生成 `burndown.csv`（按提交与完成时间推算）
  - [ ] 更新 `CHANGELOG.md` 或 `changes/*.md`
- [ ] 收尾检查与归档
  - [ ] 代码注释覆盖扫描并补全（遵循《代码风格与注释》，见 `local_notes/code风格与注释.md`）
  - [ ] 文档一致性校验：《开发计划书.md》《README.md》与实现一致
  - [ ] 对外文档英文合规（`README.md`、`docs/**`、API 文档；排除 `local_notes/**` 等非提交内容）
  - [ ] 生成收尾报告，归档至 `evidence/`（注释补全清单、文档差异清单、语言合规清单、相关 PR 链接）

> 说明：本计划书面向 Codex 执行，仅保留可验证与可追踪的信息。

## 4. 时间排期
| 日期 | 重点任务 |
| --- | --- |
| Day 1 | 项目骨架、Flyway、Supabase 配置、RLS POC |
| Day 2 | Docker 工具链、认证模块基础 |
| Day 3 | RBAC、多租户上下文、审计 |
| Day 4 | CRUD 完成、分页过滤、单元测试 |
| Day 5 | 报表、导出、OpenAPI、观测 |
| Day 6 | 集成测试、CI/CD、Koyeb 部署、Vercel 页面 |
| Day 7 | 验收、证据链整理、Demo 录制 |

<!-- 角色与职责（人类面向）已移除：Codex 专用计划不包含该段落 -->
## 6. 依赖与风险
| 风险 | 影响 | 应对 |
| --- | --- | --- |
| Supabase RLS 与连接池兼容性 | 数据串租风险 | 预先编写集成测试；必要时使用 per-request session 或连接注入 `SET LOCAL` |
| Koyeb 免费额度限制 | 服务不稳定 | 评估并升级方案或启用冷启动健康检查报警 |
| CI/CD 镜像体积过大 | 构建/部署变慢 | 采用层缓存，分离构建/运行阶段 |
| 缺少 UI Demo | 用户体验不足 | 提前确认是否需要最简前端；如需，在 Day 5 安排0.5 人日补开发 |

## 7. 质量与验收
- **功能验收**：按用户旅程执行端到端测试（待补充旅程后锁定）。
- **自动化**：`mvn verify` 集成测试通过；覆盖率门槛达标。
- **安全**：密码策略、速率限制、审计日志保留 ≥ 90 天。
- **性能**：10 并发下 P95 ≤ 300ms；RLS 查询 Explain 显示使用索引。
- **部署**：Koyeb 与 Supabase 监控告警配置完成。

## 8. CI/CD 与运维
- GitHub Actions 流程：`lint -> test -> build -> push -> deploy`。
- Koyeb 自动部署：监听 GHCR 最新 tag，启用滚动升级；失败自动回滚。
- Supabase：每日自动备份；提供只读账号给报表导出。
- 监控：Micrometer Prometheus endpoint（可选）+ Koyeb 内置日志。

<!-- 沟通机制（人类面向）已移除：Codex 专用计划不包含该段落 -->
## 10. 变更控制
- 任何范围/时间线变动需在 Change Log 记录，PM 与 Tech Lead 确认。
- 新需求插入需替换等价工作量或延期里程碑。
- 所有变更影响测试与部署的，需要同步调整 CI/CD 脚本。

## 11. 评审清单（Codex 可验证）
- [ ] DoR 达标：需求、边界、AC、依赖、优先级、指标俱全？
- [ ] WBS 粒度合适（≤1–2 人日），串并行关系清晰？
- [ ] 估算有依据，缓冲策略明确，关键路径标记完成？
- [ ] AC、测试、CI 对应关系落地了吗？如需线下验收，是否用 `N/A(理由, 证据)` 标注并提供替代证据？
- [ ] 依赖和风险有应对方案（功能开关、灰度、回滚）？
- [ ] DoD 可执行且可由 CI 验证？
- [ ] 沟通节奏、看板、变更控制是否就绪？
- [ ] 里程碑可演示、可回滚、指标可量化评估？

## 12. 验收清单
- [ ] 所有 WBS 任务标注完成并附证据。
- [ ] CI/CD 全绿，部署链接可访问。
- [ ] 文档、脚本、录屏入库（evidence/）。
- [ ] Demo 录屏可用，问答脚本已生成并入库。
- [ ] 代码注释覆盖符合《代码风格与注释》（函数/方法具备目的/参数/返回/异常/副作用）。
- [ ] 《开发计划书.md》《README.md》与实际实现一致（接口、部署、指标、证据）。
- [ ] 对外文档英文合规（非提交的内部笔记除外）。

## 13. 开发记录
| 日期 | 任务 | 负责人 | 状态 | 备注 |
| --- | --- | --- | --- | --- |
| 2025-01-XX | （示例）完成租户 RLS 集成测试 | @dev | 待更新 | - |
| 2025-01-XX |  |  |  |  |
